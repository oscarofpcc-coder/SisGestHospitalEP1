@model IEnumerable<SisGestionCitasMedicas.Models.Cita>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>


<button class="btn btn-primary" id="btnNuevo">
    + Nueva Cita
</button>
<div id="modalContainer"></div>

<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.FechaHora)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Motivo)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Estado)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Paciente)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Doctor)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.FechaHora)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Motivo)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Estado)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Paciente.Apellido)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Doctor.Apellido)
            </td>
            <td>
               
                <a asp-action="Details" asp-route-id="@item.CitaId">Details</a> |
                <a asp-action="Delete" asp-route-id="@item.CitaId">Delete</a> |
                <a class="btn btn-sm btn-warning btnEditar" data-id="@item.CitaId">Editar</a>

            </td>
        </tr>
}
        @section Scripts {
            <script>
                const modalContainer = document.getElementById("modalContainer");

                async function abrirModal(url) {
                  const res = await fetch(url);
                  const html = await res.text();
                  modalContainer.innerHTML = html;

                  const modalEl = document.getElementById("formModal");
                  const modal = new bootstrap.Modal(modalEl);
                  modal.show();

                  document.getElementById("btnGuardar").addEventListener("click", () => guardarFormulario(modal));
                }

                async function guardarFormulario(modal) {
                  const form = document.getElementById("formCita");
                  const errors = document.getElementById("formErrors");
                  errors.innerText = "";

                  const formData = new FormData(form);

                  const res = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                  });

                  if (res.ok) {
                    modal.hide();
                    location.reload(); 
                    return;
                  }

                  const msg = await res.text();
                  errors.innerText = msg || "Error al guardar";
                }

                // NUEVO
                document.getElementById("btnNuevo").addEventListener("click", () => {
                  abrirModal("/Citas/CreateModal");
                });

                // EDITAR
                document.querySelectorAll(".btnEditar").forEach(btn => {
                  btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id");
                    abrirModal(`/Citas/EditModal/${id}`);
                  });
                });
            </script>
        }

    </tbody>
</table>
